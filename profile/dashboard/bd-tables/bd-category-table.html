<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="keyword" content="" />
    <meta name="author" content="Fundsroom" />
    <!--! The above 6 meta tags *must* come first in the head; any other head content must come *after* these tags !-->
    <!--! BEGIN: Apps Title-->
    <title>Fundsroom HR || CO</title>
    <!--! END:  Apps Title-->
    <!--! BEGIN: Favicon-->
    <link rel="shortcut icon" type="image/x-icon" href="/profile/assets/images/FundsAuditLogo.png" />
    <!--! END: Favicon-->
    <!--! BEGIN: Bootstrap CSS-->
    <link rel="stylesheet" type="text/css" href="/profile/assets/css/bootstrap.min.css" />
    <!--! END: Bootstrap CSS-->
    <!--! BEGIN: Vendors CSS-->
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/vendors.min.css" />
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/daterangepicker.min.css" />
    <!--! END: Vendors CSS-->
    <!--! BEGIN: Custom CSS-->
    <link rel="stylesheet" type="text/css" href="/profile/assets/css/theme.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/tagify.min.css">
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/tagify-data.min.css">
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/quill.min.css">
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/select2.min.css">
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/select2-theme.min.css">
    <link rel="stylesheet" type="text/css" href="/profile/assets/vendors/css/daterangepicker.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script>
        function setStickyColumns() {
            const table = document.getElementById("leadsTable");
            if (!table) return;

            const stickyCols = 3;
            let leftOffsets = [];

            let total = 0;
            const firstRow = table.querySelector("thead tr:first-child");
            for (let i = 0; i < stickyCols; i++) {
                const th = firstRow.querySelector(`th:nth-child(${i + 1})`);
                if (th) {
                    leftOffsets[i] = total;
                    total += th.offsetWidth;
                }
            }

            requestAnimationFrame(() => {
                const headerRows = table.querySelectorAll("thead tr");
                let cumulativeTop = 0;

                headerRows.forEach(row => {
                    const rowHeight = row.offsetHeight;

                    row.querySelectorAll("th").forEach(th => {
                        th.style.position = "sticky";
                        th.style.top = cumulativeTop + "px";
                        th.style.background = "#fff";
                        th.style.zIndex = 12;
                    });

                    for (let i = 0; i < stickyCols; i++) {
                        const th = row.querySelector(`th:nth-child(${i + 1})`);
                        if (th) {
                            th.style.left = leftOffsets[i] + "px";
                            th.style.zIndex = 16;
                        }
                    }

                    cumulativeTop += rowHeight;
                });

                const rows = table.querySelectorAll("tbody tr");
                rows.forEach(row => {
                    for (let i = 0; i < stickyCols; i++) {
                        const td = row.querySelector(`td:nth-child(${i + 1})`);
                        if (td) {
                            td.style.position = "sticky";
                            td.style.left = leftOffsets[i] + "px";
                            td.style.background = "#fff";
                            td.style.zIndex = 6;
                        }
                    }
                });
            });
        }

        window.addEventListener("load", setStickyColumns);
        window.addEventListener("resize", setStickyColumns);
    </script>
    <!--! END: Custom CSS-->
    <!--! HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries !-->
    <!--! WARNING: Respond.js doesn"t work if you view the page via file: !-->
    <!--[if lt IE 9]>
			<script src="https:oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https:oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
</head>

<body>
    <!--! ================================================================ !-->
    <!--! [Start] Navigation Manu !-->
    <!--! ================================================================ !-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!--! ================================================================ !-->
    <!--! [End]  Navigation Manu !-->
    <!--! ================================================================ !-->
    <!--! ================================================================ !-->
    <!--! [Start] Header !-->
    <!--! ================================================================ !-->
    <!--! ================================================================ !-->
    <!--! [End] Header !-->
    <!--! ================================================================ !-->
    <!--! ================================================================ !-->
    <!--! [Start] Main Content !-->
    <!--! ================================================================ !-->
    <main class="nxl-container">
        <div class="nxl-content">
            <!-- [ page-header ] start -->

            <!-- [ page-header ] end -->
            <!-- [ Main Content ] start -->
            <div class="main-content">


                <div class="row">
                    <!-- Add this button at the top of your page -->
                    <!-- <div class="text-end mb-3">
                        <button class="btn btn-primary" onclick="printPage()">
                            <i class="bi bi-printer"></i> Print Page
                        </button>
                    </div> -->
                    <div class="mb-2 d-flex justify-content-end">
                        <button id="backBtn" class="btn btn-light btn-sm" title="Back">
                            <i class="feather-arrow-left"></i> Back
                        </button>
                    </div>

                    <!-- [Latest Leads] start -->
                    <div class="col-12">
                        <div class="card stretch stretch-full">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title"><span id="category-name"></span> SHEET of <span
                                            id="manager-name2">User</span>
                                        (Total count: <span id="collegeCount">0</span>)</h5>
                                </div>
                                <div class="card-header-action">
                                    <!-- <div data-bs-toggle="tooltip" title="Refresh">
                                        <a href="javascript:void(0);" class="avatar-text avatar-xs bg-warning"
                                            onclick="loadTableData()"> </a>
                                    </div> -->
                                    <div class="search-wrapper" id="searchWrapper">
                                        <button id="searchToggle" class="search-icon">
                                            <img src="https://cdn-icons-png.flaticon.com/512/622/622669.png"
                                                alt="Search" width="20" height="20">
                                        </button>
                                        <div class="search-bar" id="searchBar">
                                            <input type="text" id="searchInput" class="form-control"
                                                placeholder="Search..." oninput="filterTable()">
                                        </div>
                                    </div>

                                    <div data-bs-toggle="tooltip" title="Maximize/Minimize">
                                        <a href="javascript:void(0);" class="avatar-xs" data-bs-toggle="expand">
                                            <i class="feather-maximize maximize" style="font-size: 15px;"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="card-body custom-card-action p-0">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover mb-0" id="leadsTable">
                                        <thead class="table-light">
                                            <tr class="border-b">
                                                <!-- <th>Delete</th> -->
                                                <th>SR</th>
                                                <th>NAME OF STUDENT</th>
                                                <th>MOBILE NUMBER</th>
                                                <th>EMAIL ID</th>
                                                <th>ACTIVE STATUS</th>
                                                <th>BUSINESS TASKS</th>
                                                <th>CATEGORY</th>
                                                <th>DOMAIN</th>
                                                <th>Start Date</th>
                                                <th>End Date</th>
                                                <th>Connect Date</th>
                                                <th>Call Status</th>
                                                <th>Registration Status</th>
                                                <th>Selection Test</th>
                                                <th>WhatsApp Group</th>
                                                <th>Day 1 Attendance</th>
                                                <th>Day 1 Date </th>
                                                <th>Day 1 Domain Task</th>
                                                <th>Day 2 Attendance</th>
                                                <th>Day 2 Date </th>
                                                <th>Day 2 Domain Task</th>
                                                <th>Day 3 Attendance</th>
                                                <th>Day 3 Date </th>
                                                <th>Day 3 Domain Task</th>
                                                <th>Day 4 Attendance</th>
                                                <th>Day 4 Date </th>
                                                <th>Day 4 Domain Task</th>
                                                <th>Day 5 Attendance</th>
                                                <th>Day 5 Date </th>
                                                <th>Day 5 Domain Task</th>
                                                <th>Day 6 Attendance</th>
                                                <th>Day 6 Date </th>
                                                <th>Day 6 Domain Task</th>
                                                <th>Day 7 Attendance</th>
                                                <th>Day 7 Date </th>
                                                <th>Day 7 Domain Task</th>
                                                <th>Module 2 Status</th>
                                                <th>TL Allocated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows dynamically injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <ul class="list-unstyled d-flex align-items-center gap-2 mb-0 pagination-common-style"
                                        id="pagination">
                                        <!-- Pagination links will be dynamically populated here -->
                                    </ul>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary" onclick="printTable()">
                                            <i class="bi bi-printer"></i> Print
                                        </button>
                                        <button class="btn btn-success" onclick="exportToExcel()">
                                            <i class="bi bi-file-earmark-excel"></i> Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        #dateRangePicker2::placeholder {
                            font-weight: 700;
                            color: #000;
                            opacity: 1;
                        }

                        .search-wrapper {
                            position: relative;
                            display: flex;
                            align-items: center;
                        }

                        .search-icon {
                            background: none;
                            border: none;
                            cursor: pointer;
                            margin-right: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 4px;
                        }

                        .search-bar {
                            display: none;
                        }

                        .search-bar.active {
                            display: block;
                        }

                        #searchInput {
                            padding: 6px 10px;
                            border: 1px solid #ccc;
                            border-radius: 6px;
                        }
                    </style>

                    <script>
                        const searchToggle = document.getElementById("searchToggle");
                        const searchBar = document.getElementById("searchBar");
                        const searchWrapper = document.getElementById("searchWrapper");

                        searchToggle.addEventListener("click", () => {
                            const isActive = searchBar.classList.toggle("active");

                            if (isActive) {
                                document.getElementById("searchInput").focus();

                                loadTableData();
                                loadTableData2();
                            }
                        });

                        document.addEventListener("click", (event) => {
                            if (!searchWrapper.contains(event.target)) {
                                searchBar.classList.remove("active");
                            }
                        });
                    </script>

                    <style>
                        .table-responsive {
                            overflow-x: auto;
                            position: relative;
                        }

                        #leadsTable {
                            border-collapse: collapse;
                            width: max-content;
                            font-family: 'Inter', sans-serif;
                            font-size: 14px;
                            background: #fff;
                            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                            border-radius: 8px;
                        }

                        .column-filter {
                            display: inline-block !important;
                            width: 100%;
                            margin-top: 4px;
                        }


                        #leadsTable th {
                            font-weight: 600;
                            text-align: left;
                            padding: 8px 12px;
                            border-bottom: 2px solid #e5e7eb;
                            position: sticky;
                            top: 0;
                            z-index: 10;
                        }

                        #leadsTable th:nth-child(-n+3) {
                            background: #fff;
                            color: #000;
                            z-index: 15;
                        }

                        #leadsTable th:nth-child(n+4) {
                            background: #fff;
                            color: #000;
                            font-weight: bold;
                            font-size: 13px;
                        }

                        #leadsTable td {
                            vertical-align: middle;
                            padding: 8px 12px;
                            white-space: nowrap;
                            border-bottom: 1px solid #f1f5f9;
                        }

                        /* #leadsTable tr:nth-child(even) td {
                            background: #fafafa;
                        } */

                        #leadsTable tr:hover td {
                            background: #f1f5ff;
                        }

                        #leadsTable th:nth-child(-n+3),
                        #leadsTable td:nth-child(-n+3) {
                            position: sticky;
                            left: 0;
                            z-index: 5;
                            border-right: 1px solid #dee2e6;
                            background: #fff;
                            font-size: 13px;
                        }

                        #leadsTable input,
                        #leadsTable select {
                            display: none;
                            width: 100%;
                            font-size: 14px;
                            padding: 6px 8px;
                            border: 1px solid #cbd5e1;
                            border-radius: 6px;
                            background: #fff;
                        }

                        #leadsTable td.editing input,
                        #leadsTable td.editing select {
                            display: block;
                        }

                        #leadsTable td span {
                            display: inline-block;
                            width: 100%;
                            min-height: 22px;
                            font-size: 14px;
                            cursor: pointer;
                            color: #1e293b;
                        }

                        #leadsTable td.editing {
                            background: #ffffff;
                            box-shadow: inset 0 0 0 2px #fff;
                        }

                        /* Columns 7 to 13 – Soft Amber */
                        #leadsTable th:nth-child(9),
                        #leadsTable th:nth-child(10),
                        #leadsTable th:nth-child(11),
                        #leadsTable th:nth-child(12),
                        #leadsTable th:nth-child(13),
                        #leadsTable th:nth-child(14),
                        #leadsTable th:nth-child(15) {
                            background-color: #f3e8ff !important;
                            /* Light Purple */
                            color: #4b1d79;
                        }

                        #leadsTable th:nth-child(16),
                        #leadsTable th:nth-child(17),
                        #leadsTable th:nth-child(18) {
                            background-color: #fff8e1 !important;
                            /* Soft Amber */
                            color: #b36b00;
                        }

                        /* Columns 16 & 17 – Teal tone */
                        #leadsTable th:nth-child(19),
                        #leadsTable th:nth-child(20),
                        #leadsTable th:nth-child(21) {
                            background-color: #e0fffa !important;
                            /* Light Teal */
                            color: #0b4f47;
                        }

                        /* Columns 18 & 19 – Gray tone */
                        #leadsTable th:nth-child(22),
                        #leadsTable th:nth-child(23),
                        #leadsTable th:nth-child(24) {
                            background-color: #d6d8dc !important;
                            /* Soft Gray */
                            color: #374151;
                        }

                        #leadsTable th:nth-child(25),
                        #leadsTable th:nth-child(26),
                        #leadsTable th:nth-child(27) {
                            background-color: #fff0e1 !important;
                            /* Orange */
                            color: #7c2d12;
                        }

                        #leadsTable th:nth-child(28),
                        #leadsTable th:nth-child(29),
                        #leadsTable th:nth-child(30) {
                            background-color: #e0f2ff !important;
                            /* Blue */
                            color: #0c4a6e;
                        }

                        #leadsTable th:nth-child(31),
                        #leadsTable th:nth-child(32),
                        #leadsTable th:nth-child(33) {
                            background-color: #dbffdd !important;
                            /* Yellow */
                            color: #127128;
                        }

                        /* Optional: for C1 section */
                        #leadsTable th:nth-child(34),
                        #leadsTable th:nth-child(35),
                        #leadsTable th:nth-child(36) {
                            background-color: #ffe5e5 !important;
                            /* Red */
                            color: #7f1d1d;
                        }
                    </style>

                    <style>
                        /* Remove leftover space from sidebar */
                        .nxl-container {
                            margin-left: 0 !important;
                            padding-left: 0 !important;
                            width: 100% !important;
                        }

                        .nxl-content {
                            margin-left: 0 !important;
                            padding-left: 0 !important;
                            width: 100% !important;
                        }

                        /* Make row use full width */
                        .main-content .row {
                            margin-left: 0 !important;
                            margin-right: 0 !important;
                        }
                    </style>

                </div>

                <div class="row" style="margin-bottom: 3%;">

    </main>
    <!--! ================================================================ !-->
    <!--! [End] Main Content !-->
    <!--! ================================================================ !-->
    <!--! ================================================================ !-->
    <!--! BEGIN: Theme Customizer !-->
    <!--! ================================================================ !-->

    <!--! ================================================================ !-->
    <!--! [End] Theme Customizer !-->
    <!--! ================================================================ !-->
    <!--! ================================================================ !-->
    <!--! Footer Script !-->
    <!--! ================================================================ !-->
    <!--! BEGIN: Vendors JS !-->
    <script src="/profile/assets/vendors/js/vendors.min.js"></script>
    <!-- vendors.min.js {always must need to be top} -->
    <script src="/profile/assets/vendors/js/daterangepicker.min.js"></script>
    <script src="/profile/assets/vendors/js/apexcharts.min.js"></script>
    <script src="/profile/assets/vendors/js/circle-progress.min.js"></script>
    <script src="/profile/assets/vendors/js/jquery.calendar.min.js"></script>
    <script src="/profile/assets/vendors/js/select2.min.js"></script>
    <script src="/profile/assets/vendors/js/select2-active.min.js"></script>
    <script src="/profile/assets/js/common-init.min.js"></script>
    <script src="/profile/assets/vendors/js/lslstrength.min.js"></script>
    <!--! END: Vendors JS !-->
    <!--! BEGIN: Apps Init  !-->
    <script src="/profile/assets/js/reports-project-init.min.js"></script>
    <script src="/profile/assets/js/widgets-charts-init.min.js"></script>
    <script src="/profile/assets/js/widgets-miscellaneous-init.min.js"></script>
    <!--! END: Apps Init !-->
    <!--! BEGIN: Theme Customizer  !-->
    <script src="/profile/assets/js/theme-customizer-init.min.js"></script>
    <!--! END: Theme Customizer !-->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        $("#backBtn").click(function () {
            console.log("Back button clicked");
            window.history.back();
        });
    </script>

    <script>
        const managerName6 = sessionStorage.getItem("userName");
        const nameElement2 = document.getElementById("manager-name2");
        if (nameElement2 && managerName6 && managerName6.trim() !== "") {
            nameElement2.textContent = managerName6;
        }
    </script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const categoryFromUrl = urlParams.get('category');
        console.log("Category from URL:", categoryFromUrl);

        const nameElement3 = document.getElementById("category-name");
        if (nameElement3 && categoryFromUrl && categoryFromUrl.trim() !== "") {
            nameElement3.textContent = categoryFromUrl.toUpperCase();
        }

        const teamManagerId = sessionStorage.getItem("user_id");
        const managerName = sessionStorage.getItem("userName");
        console.log("managerName:", managerName);
        console.log(teamManagerId);

        const apiBase = "https://eduroom.in/api/v1/bdsheet";

        const dropdowns = {
            callStatus: ["Connected", "Not Answered", "Busy", "Not Interested"],
            whatsappGroup: ["Joined", "Not Joined"],
            sessionAttendance: ["Active", "Inactive", "Not Attended", "Left", "Terminated"],
            domainTask: ["Completed", "In Progress", "Not Started", "Pending"],
            module2Status: ["Promoted", "Not Promoted", "On Hold"],
            activeStatus: ["Active", "Inactive", "Terminated", "Left"]
        };

        const categoryColors = {
            "not working": "#f93939",   // Red
            "Starter": "#f57e2f",       // Orange
            "Basic": "#d6cf3e",         // Yellow-Gold
            "Bronze": "#b436f4",        // Purple
            "Silver": "#fd1ff2",        // Pink
            "Gold": "#585ff3",          // Indigo
            "Platinum": "#8cee89",      // Light Green
            "Diamond": "#1af706"        // Neon Green
        };

        let tableData = [];
        let filteredData = [];
        let managers = [];
        const rowsPerPage = 10;
        let currentPage = 1;

        function loadTableData() {
            $.ajax({
                url: `https://eduroom.in/api/v1/bdsheet/category?managerId=${teamManagerId}&category=${categoryFromUrl}`,
                method: "GET",
                success: function (res) {
                    console.log("student resumes:", res);
                    if (res.managers) {
                        managers = res.managers;
                    }

                    if (res.success && res.data) {
                        tableData = res.data.map((row, index) => {
                            const bdSheet = row.BdSheets && row.BdSheets.length > 0 ? row.BdSheets[0] : {};

                            const day1 = bdSheet.day1 || {};
                            const day2 = bdSheet.day2 || {};
                            const day3 = bdSheet.day3 || {};
                            const day4 = bdSheet.day4 || {};
                            const day5 = bdSheet.day5 || {};
                            const day6 = bdSheet.day6 || {};
                            const day7 = bdSheet.day7 || {};

                            return {
                                sno: index + 1,
                                id: row.id,
                                studentName: row.studentName || "",
                                mobileNumber: row.mobileNumber || "",
                                emailId: row.emailId || "",
                                activeStatus: bdSheet.activeStatus || "",
                                businessTask: row.businessTask || "",
                                category: row.category || "",
                                domain: row.domain || "",

                                startDate: bdSheet.startDate || "",
                                endDate: bdSheet.endDate || "",
                                connectDate: bdSheet.connectDate || "",
                                callStatus: bdSheet.callStatus || "",
                                registration: bdSheet.registration || "",
                                selectionTest: bdSheet.selectionTest || "",
                                whatsappGroup: bdSheet.whatsappGroup || "",
                                // Day 1
                                day1Date: day1.date || "",
                                day1SessionAttendance: day1.sessionAttendance || "",
                                day1DomainTask: day1.domainTask || "",
                                // Day 2
                                day2Date: day2.date || "",
                                day2SessionAttendance: day2.sessionAttendance || "",
                                day2DomainTask: day2.domainTask || "",
                                // Day 3
                                day3Date: day3.date || "",
                                day3SessionAttendance: day3.sessionAttendance || "",
                                day3DomainTask: day3.domainTask || "",
                                // Day 4
                                day4Date: day4.date || "",
                                day4SessionAttendance: day4.sessionAttendance || "",
                                day4DomainTask: day4.domainTask || "",
                                // Day 5
                                day5Date: day5.date || "",
                                day5SessionAttendance: day5.sessionAttendance || "",
                                day5DomainTask: day5.domainTask || "",
                                // Day 6
                                day6Date: day6.date || "",
                                day6SessionAttendance: day6.sessionAttendance || "",
                                day6DomainTask: day6.domainTask || "",
                                // Day 7
                                day7Date: day7.date || "",
                                day7SessionAttendance: day7.sessionAttendance || "",
                                day7DomainTask: day7.domainTask || "",

                                module2Status: bdSheet.module2Status || "",
                                tlAllocated: bdSheet.tlAllocated || "",

                                bdSheetId: bdSheet.id
                            };
                        });

                        $("#collegeCount").text(tableData.length);
                        filteredData = [...tableData];
                        renderTable();
                        renderPagination();
                        renderColumnFilters();
                    }
                }
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return "";
            let date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString("en-GB", {
                day: "numeric",
                month: "long",
                year: "numeric"
            });
        }

        function getRowColor(category) {
            return categoryColors[category] || "#FFFFFF";
        }

        function renderTable() {
            let tbody = $("#leadsTable tbody");
            tbody.empty();

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const rows = filteredData.slice(start, end);

            rows.forEach((row) => {
                const category = row.category || "";
                const rowColor = getRowColor(category);

                let tr = `<tr data-id="${row.id}" data-bdsheet-id="${row.bdSheetId || ''}" style="background-color: ${rowColor};">
                <td>${row.sno}</td>
                <td>${row.studentName || ""}</td>
                <td>${row.mobileNumber || ""}</td>
                <td>${row.emailId || ""}</td>
                ${makeDropdownCell("activeStatus", row.activeStatus || "", null, dropdowns.activeStatus)}
                <td>${row.businessTask || 0}</td>
                <td>${row.category ? row.category.charAt(0).toUpperCase() + row.category.slice(1) : ""}</td>
                <td>${row.domain || ""}</td>
                ${makeDateCell("startDate", row.startDate || "")}
                ${makeDateCell("endDate", row.endDate || "")}
                ${makeDateCell("connectDate", row.connectDate || "")}
                ${makeDropdownCell("callStatus", row.callStatus || "", null, dropdowns.callStatus)}
                ${makeReadonlyCell("registration", (row.registration || "").charAt(0).toUpperCase() + (row.registration || "").slice(1).toLowerCase())}
                ${makeReadonlyCell("selectionTest", row.selectionTest || "")}
                ${makeDropdownCell("whatsappGroup", row.whatsappGroup || "", null, dropdowns.whatsappGroup)}
                ${makeDropdownCell("day1SessionAttendance", row.day1SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day1Date", row.day1Date || "")}
                ${makeDropdownCell("day1DomainTask", row.day1DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day2SessionAttendance", row.day2SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day2Date", row.day2Date || "")}
                ${makeDropdownCell("day2DomainTask", row.day2DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day3SessionAttendance", row.day3SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day3Date", row.day3Date || "")}
                ${makeDropdownCell("day3DomainTask", row.day3DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day4SessionAttendance", row.day4SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day4Date", row.day4Date || "")}
                ${makeDropdownCell("day4DomainTask", row.day4DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day5SessionAttendance", row.day5SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day5Date", row.day5Date || "")}
                ${makeDropdownCell("day5DomainTask", row.day5DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day6SessionAttendance", row.day6SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day6Date", row.day6Date || "")}
                ${makeDropdownCell("day6DomainTask", row.day6DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("day7SessionAttendance", row.day7SessionAttendance || "", null, dropdowns.sessionAttendance)}
                ${makeDateCell("day7Date", row.day7Date || "")}
                ${makeDropdownCell("day7DomainTask", row.day7DomainTask || "", null, dropdowns.domainTask)}
                ${makeDropdownCell("module2Status", row.module2Status || "", null, dropdowns.module2Status)}
                ${makeDropdownCell("tlAllocated", row.tlAllocated || "", null, managers.map(m => m.name))}
            </tr>`;
                tbody.append(tr);
            });

            attachCellEvents();
            setStickyColumns();
        }

        const columnKeys = [
            "sno",
            "studentName",
            "mobileNumber",
            "emailId",
            "activeStatus",
            "businessTask",
            "category",
            "domain",
            "startDate",
            "endDate",
            "connectDate",
            "callStatus",
            "registration",
            "selectionTest",
            "whatsappGroup",
            "day1SessionAttendance",
            "day1Date",
            "day1DomainTask",
            "day2SessionAttendance",
            "day2Date",
            "day2DomainTask",
            "day3SessionAttendance",
            "day3Date",
            "day3DomainTask",
            "day4SessionAttendance",
            "day4Date",
            "day4DomainTask",
            "day5SessionAttendance",
            "day5Date",
            "day5DomainTask",
            "day6SessionAttendance",
            "day6Date",
            "day6DomainTask",
            "day7SessionAttendance",
            "day7Date",
            "day7DomainTask",
            "module2Status",
            "tlAllocated"
        ];

        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const pagination = $("#pagination");
            pagination.empty();

            const visiblePageCount = 3;
            let startPage = Math.max(currentPage - 1, 1);
            let endPage = startPage + visiblePageCount - 1;
            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(endPage - visiblePageCount + 1, 1);
            }

            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';

            pagination.append(`<li><a href="javascript:void(0);" class="${prevDisabled}" onclick="changePage(${currentPage - 1})">&laquo;</a></li>`);

            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? "active" : "";
                pagination.append(`<li><a href="javascript:void(0);" class="${active}" onclick="changePage(${i})">${i}</a></li>`);
            }

            pagination.append(`<li><a href="javascript:void(0);" class="${nextDisabled}" onclick="changePage(${currentPage + 1})">&raquo;</a></li>`);
        }

        window.changePage = function (page) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
        };

        function renderColumnFilters() {
            const headerRow = $("#leadsTable thead tr.filters");
            headerRow.remove();

            let filterRow = "<tr class='filters'>";
            columnKeys.forEach((key, i) => {
                if (key === "actions" || key === "sno") {
                    filterRow += "<th></th>";
                } else {
                    filterRow += `<th>
                    <select class="column-filter form-select form-select-sm" data-field="${key}">
                        <option value="">All</option>
                    </select>
                </th>`;
                }
            });
            filterRow += "</tr>";
            $("#leadsTable thead").append(filterRow);

            populateColumnFilterOptions();

            $(".column-filter").off("change").on("change", function () {
                applyFilters();
            });
        }

        function populateColumnFilterOptions() {
            $("#leadsTable thead .column-filter").each(function () {
                const field = $(this).data("field");
                let values = [];

                if (field.toLowerCase().includes("date")) {
                    values = [...new Set(
                        tableData
                            .map(row => formatDate(row[field]))
                            .filter(v => v && v.trim() !== "")
                    )];
                } else {
                    values = [...new Set(
                        tableData
                            .map(row => row[field])
                            .filter(v => v !== null && v !== undefined && v !== "")
                    )];
                }

                $(this).empty().append(`<option value="">All</option>`);
                values.forEach(v => {
                    $(this).append(`<option value="${v}">${v}</option>`);
                });
            });
        }

        function applyFilters() {
            filteredData = [...tableData];

            $("#leadsTable thead .column-filter").each(function () {
                const value = $(this).val();
                const field = $(this).data("field");

                if (value) {
                    filteredData = filteredData.filter(row => {
                        let cellValue = "";

                        if (field.toLowerCase().includes("date")) {
                            cellValue = formatDate(row[field] || "");
                        } else {
                            cellValue = row[field] || "";
                        }

                        return String(cellValue).toLowerCase() === String(value).toLowerCase();
                    });
                }
            });

            currentPage = 1;
            renderTable();
            renderPagination();
        }

        function makeCell(field, value) {
            let displayValue = value || "";
            const safeVal = String(displayValue).replace(/"/g, "&quot;");
            return `<td data-field="${field}">
            <span>${displayValue}</span>
            <input type="text" value="${safeVal}">
        </td>`;
        }

        function makeReadonlyCell(field, value) {
            let displayValue = value || "";
            return `<td data-field="${field}">
            <span>${displayValue}</span>
        </td>`;
        }

        function makeDateCell(field, value) {
            let displayValue = formatDate(value);
            let rawValue = value ? new Date(value).toISOString().split("T")[0] : "";
            return `<td data-field="${field}">
            <span>${displayValue}</span>
            <input type="text" class="date-picker" value="${rawValue}">
        </td>`;
        }

        function makeDropdownCell(field, selectedValue, stateFilter = null, optionsList = null) {
            let options = optionsList || dropdowns[field] || [];

            const formatLabel = (val) => {
                if (!val) return "";
                return String(val).charAt(0).toUpperCase() + String(val).slice(1);
            };

            let displaySelected = formatLabel(selectedValue);

            let html = `<td data-field="${field}">
            <span style="font-weight:bold;">${displaySelected}</span>
            <select class="form-control select2">`;

            html += `<option value="" ${!selectedValue ? "selected" : ""}></option>`;
            options.forEach(opt => {
                let sel = (String(opt).toLowerCase() === String(selectedValue || "").toLowerCase()) ? "selected" : "";
                html += `<option value="${opt}" ${sel}>${formatLabel(opt)}</option>`;
            });

            html += `</select></td>`;
            return html;
        }

        function attachCellEvents() {
            $("#leadsTable td").off("dblclick").on("dblclick", function () {
                let td = $(this);

                if (td.find("input").length === 0 && td.find("select").length === 0) return;
                td.addClass("editing");
                td.find("input,select").focus();
            });

            $("#leadsTable td input, #leadsTable td select")
                .off("blur change")
                .on("blur change", function (ev) {
                    if ($(this).hasClass("date-picker")) return;

                    let td = $(this).closest("td");
                    let tr = $(this).closest("tr");
                    let id = tr.data("id");
                    let bdSheetId = tr.data("bdsheet-id");
                    let field = td.data("field");
                    let value = $(this).val();

                    td.find("span").text(value);
                    td.removeClass("editing");

                    updateBdSheetRecord(id, bdSheetId, field, value);
                });

            $(".date-picker").each(function () {
                const input = $(this);
                input.flatpickr({
                    dateFormat: "Y-m-d",
                    onChange: function (selectedDates, dateStr) {
                        if (!dateStr) return;

                        let td = input.closest("td");
                        let tr = input.closest("tr");
                        let id = tr.data("id");
                        let bdSheetId = tr.data("bdsheet-id");
                        let field = td.data("field");
                        let value = new Date(dateStr).toISOString().split("T")[0];

                        td.find("span").text(formatDate(value));
                        td.removeClass("editing");

                        updateBdSheetRecord(id, bdSheetId, field, value);
                    }
                });
            });

            $("#leadsTable td select.select2").each(function () {
                if ($(this).select2) {
                    $(this).select2({ width: '100%' });
                }
            });
        }

        function updateBdSheetRecord(studentResumeId, bdSheetId, field, value) {
            let payload = {
                studentResumeId: studentResumeId
            };

            if (['startDate', 'endDate', 'connectDate', 'callStatus', 'registration',
                'selectionTest', 'whatsappGroup', 'module2Status', 'tlAllocated', 'activeStatus'].includes(field)) {
                payload[field] = value;
            }

            else if (field.startsWith('day1')) {
                const dayField = field.replace('day1', '').charAt(0).toLowerCase() + field.replace('day1', '').slice(1);
                payload.day1 = payload.day1 || {};
                payload.day1[dayField] = value;
            }

            else if (field.startsWith('day2')) {
                const dayField = field.replace('day2', '').charAt(0).toLowerCase() + field.replace('day2', '').slice(1);
                payload.day2 = payload.day2 || {};
                payload.day2[dayField] = value;
            }

            else if (field.startsWith('day3')) {
                const dayField = field.replace('day3', '').charAt(0).toLowerCase() + field.replace('day3', '').slice(1);
                payload.day3 = payload.day3 || {};
                payload.day3[dayField] = value;
            }

            else if (field.startsWith('day4')) {
                const dayField = field.replace('day4', '').charAt(0).toLowerCase() + field.replace('day4', '').slice(1);
                payload.day4 = payload.day4 || {};
                payload.day4[dayField] = value;
            }

            else if (field.startsWith('day5')) {
                const dayField = field.replace('day5', '').charAt(0).toLowerCase() + field.replace('day5', '').slice(1);
                payload.day5 = payload.day5 || {};
                payload.day5[dayField] = value;
            }

            else if (field.startsWith('day6')) {
                const dayField = field.replace('day6', '').charAt(0).toLowerCase() + field.replace('day6', '').slice(1);
                payload.day6 = payload.day6 || {};
                payload.day6[dayField] = value;
            }

            else if (field.startsWith('day7')) {
                const dayField = field.replace('day7', '').charAt(0).toLowerCase() + field.replace('day7', '').slice(1);
                payload.day7 = payload.day7 || {};
                payload.day7[dayField] = value;
            }

            if (teamManagerId) {
                payload["teamManagerId"] = teamManagerId;
            }

            console.log("UPSERT payload:", payload);

            $.ajax({
                url: `${apiBase}/upsert`,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                success: function (res) {
                    console.log("UPSERT success:", res);

                    if (!bdSheetId && res.data && res.data.id) {
                        loadTableData();
                    }
                },
                error: function (err) {
                    console.error("UPSERT failed", err);
                    alert("Failed to update record. Please try again.");
                }
            });
        }

        window.filterTable = function () {
            const value = $("#searchInput").val().toLowerCase().trim();
            if (!value) {
                renderTable();
                renderPagination();
                return;
            }

            filteredData = tableData.filter((row) =>
                Object.values(row).some((field) => {

                    const plainText = $('<div>').html(field === null || field === undefined ? "" : String(field)).text().toLowerCase().trim();
                    return plainText.includes(value);
                })
            );

            currentPage = 1;
            renderTable();
            renderPagination();
        };

        window.printTable = function () {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Print Table</title></head><body>');
            printWindow.document.write($("#leadsTable")[0].outerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        };

        window.exportToExcel = function () {
            const headers = [
                "S.No",
                "Student Name",
                "Mobile Number",
                "Email ID",
                "Lead Source",
                "Business Task",
                "Category",
                "Domain",
                "Start Date",
                "End Date",
                "Connect Date",
                "Call Status",
                "Registration",
                "Selection Test",
                "WhatsApp Group",
                "Day1 Session Attendance",
                "Day1 Date",
                "Day1 Domain Task",
                "Day2 Session Attendance",
                "Day2 Date",
                "Day2 Domain Task",
                "Day3 Session Attendance",
                "Day3 Date",
                "Day3 Domain Task",
                "Day4 Session Attendance",
                "Day4 Date",
                "Day4 Domain Task",
                "Day5 Session Attendance",
                "Day5 Date",
                "Day5 Domain Task",
                "Day6 Session Attendance",
                "Day6 Date",
                "Day6 Domain Task",
                "Day7 Session Attendance",
                "Day7 Date",
                "Day7 Domain Task",
                "Module 2 Status",
                "TL Allocated"
            ];

            const data = [headers];

            tableData.forEach((row) => {
                const rowData = [
                    row.sno,
                    row.studentName,
                    row.mobileNumber,
                    row.emailId,
                    row.activeStatus,
                    row.businessTask,
                    row.category,
                    row.domain,
                    formatDate(row.startDate),
                    formatDate(row.endDate),
                    formatDate(row.connectDate),
                    row.callStatus,
                    row.registration,
                    row.selectionTest,
                    row.whatsappGroup,
                    row.day1SessionAttendance,
                    formatDate(row.day1Date),
                    row.day1DomainTask,
                    row.day2SessionAttendance,
                    formatDate(row.day2Date),
                    row.day2DomainTask,
                    row.day3SessionAttendance,
                    formatDate(row.day3Date),
                    row.day3DomainTask,
                    row.day4SessionAttendance,
                    formatDate(row.day4Date),
                    row.day4DomainTask,
                    row.day5SessionAttendance,
                    formatDate(row.day5Date),
                    row.day5DomainTask,
                    row.day6SessionAttendance,
                    formatDate(row.day6Date),
                    row.day6DomainTask,
                    row.day7SessionAttendance,
                    formatDate(row.day7Date),
                    row.day7DomainTask,
                    row.module2Status,
                    row.tlAllocated
                ];

                data.push(rowData);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "BDSheetData");
            XLSX.writeFile(workbook, "BDSheet_Data.xlsx");
        };

        $(document).ready(function () {
            loadTableData();
            setStickyColumns();
        });
    </script>

    <script>
        document.addEventListener("click", function (e) {
            if (e.target.closest(".delete-record")) {
                let button = e.target.closest(".delete-record");
                let recordId = button.getAttribute("data-id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This action cannot be undone!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#6c757d",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log("Deleting record with ID:", recordId);

                        $.ajax({
                            url: `https://eduroom.in/api/v1/cosheet/cosheet/${recordId}`,
                            method: "DELETE",
                            success: function (res) {
                                Swal.fire(
                                    "Deleted!",
                                    "The record has been deleted.",
                                    "success"
                                );

                                $(`#leadsTable2 tr[data-id="${recordId}"]`).remove();
                            },
                            error: function (err) {
                                console.error("Delete failed", err);
                                Swal.fire(
                                    "Error!",
                                    "Failed to delete the record.",
                                    "error"
                                );
                            }
                        });
                    }
                });
            }
        });
    </script>

    <script>
        document.addEventListener("click", function (e) {
            if (e.target.closest(".delete-record")) {
                let button = e.target.closest(".delete-record");
                let recordId = button.getAttribute("data-id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This action cannot be undone!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#6c757d",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log("Deleting record with ID:", recordId);

                        $.ajax({
                            url: `https://eduroom.in/api/v1/studentresume/delete/${recordId}`,
                            method: "DELETE",
                            success: function (res) {
                                Swal.fire(
                                    "Deleted!",
                                    "The record has been deleted.",
                                    "success"
                                ).then(() => {
                                    $(button).closest("tr").remove();
                                });
                            },
                            error: function (err) {
                                console.error("Delete failed", err);
                                Swal.fire(
                                    "Error!",
                                    "Failed to delete the record.",
                                    "error"
                                );
                            }
                        });
                    }
                });
            }
        });
    </script>

</body>

</html>